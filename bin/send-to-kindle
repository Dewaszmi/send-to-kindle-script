#!/usr/bin/env bash

$SENDER_MAIL=$(secret-tool lookup send-to-kindle sender_mail)
$KINDLE_MAIL=$(secret-tool lookup send-to-kindle kindle_mail)
$USERNAME=$(secret-tool lookup send-to-kindle username)
$PASSWORD=$(secret-tool lookup send-to-kindle password)

if [[ -z "$SENDER_MAIL" || -z "$KINDLE_MAIL" || -z "$USERNAME" || -z "$PASSWORD" ]]; then
    echo "Error: Failed to retrieve credentials from the keyring."
    exit 1
fi

# uses gmail server with SSL by default
relay="smtp.gmail.com"
port="465"
encryption="SSL"

language=""
books=()
new_books=()

while [[ $# -gt 0 ]]; do
    case "$1" in
        -l)
            shift
            if [[ -z "$1" || "$1" =~ ^- ]]; then
                echo 'Usage: "-l [language_code]"'
                exit 1
            fi
            language="$1"
            ;;
        -*)
            echo "Unknown option: $1"
            exit 1
            ;;
        *)
            if [[ -f "$1" ]]; then
                ext="${1##*.}"
                out="${1%.*}.epub"
                if [[ "$ext" != "epub" ]]; then
                    ebook-convert "$1" "$out"
                    new_books+=("$out")
                fi
                if [[ -n "$language" ]]; then
                    ebook-meta "$out" -l "$language"
                fi
                books+=("$out")
            else
                echo "No file $1."
            fi
            ;;
    esac
    shift
done

for book in "${books[@]}"; do
    cmd="calibre-smtp \
        --relay \"$relay\" --port \"$port\" --encryption \"$encryption\" \
        --username \"$USERNAME\" --password \"$PASSWORD\" \
        --attachment \"$book\" --subject \"Send to Kindle: $book\" \
        \"$SENDER_MAIL\" \"$KINDLE_MAIL\" \"Happy reading :)\""

    eval "$cmd"

    if [ $? -eq 0 ]; then
        echo "\"$book\" sent successfully."
    else
        echo "Failed to send \"$book\"."
    fi

    for new in "${new_books[@]}"; do
        if [[ "$book" == "$new" ]]; then
            rm "$book"
            break
        fi
    done
done